== Usage

=== How to implement OIL on your site

Setting up OIL on your page consists of the following steps:

** Add the oil.js javascript snippet to your page
** Add a configuration block to your pages DOM

OIL creates a standard for the OptIn but can't automatically stops your site from tracking your users. So to actually make your page respond to optins you also need to to the following.

** Make sure your page doesn't track the user in its default state.
** Use Tealium for all tracking activities
** Listen to OIL events for activating non-Tealium tags, after the user opted in.

==== Adding oil.js to your site via Tealium (recommended)

Axel Springer Tealium needs to configure your site inheriting from the predefined lib-dip-optin library profile. Once this is in place you publish those changes in the following way:

* Open your Tealium profile and go to "extensions"
* Find the entry for "AS Opt-in Overlay", you'll be noticed of a change to this extension
* Publish / deploy your profile to activate the changes to Oil.js

[caption="Oil.js Tealium Deployment"]
image::src/images/tealium-user-profile-extension-view.png[Tealium Client Profile]

This needs to be repeated for every new version of OIL. The library profile can't push new code to your website without your action.

==== Adding oil.js to your site via direct integration

If Tealium can't be used on your site you also can add OIL directly from our CDN.

Example:
[source, javascript]
----
<script type="text/javascript" src="https://oil.axelspringer.com/release/oil.1.0.7.min.js"></script>
----

Updated versions of the script will be deployed using a different filename hence we'll never alter an existing version.

Please make sure you're working with the latest version available.

Check https://oil.axelspringer.com/ for further updates.

IMPORTANT: Your domain needs to be whitelisted in order to work with OIL (contact us to get whitelisted: Team ANDROID AGASSI <ANDROIDAGASSI@moveoffice.com>)

include::usage/configruation-of-oil.adoc[]

=== Listening and interacting with OIL

Set aside the configuration the host site can communicate with the OIL layer within a running site and react to its status. Also a implementing developer can debug the layer using the console logs the OIL layer can create.

==== Test Deployment and Preview Mode
The preview mode is useful for testing OIL in a live environment without making it available to your end-users.

The preview mode is turned off by default, meaning OIL will be available to all your users. If you turn the preview mode on (please see configuration), OIL won't be shown at first, but can be enabled for your current session on the browser's console:
[source,javascript]
----
window.oilPreviewModeOn();
----

and turned off again

[source,javascript]
----
window.oilPreviewModeOff();
----

When Preview mode is turned on useful debug information will be seen on the browser console. See also "Verbose Logging" below for more detailed logging.

==== OIL Verbose Logging
In a production build OIL will show no logs, except in preview_mode or verbose mode.

Run the following commands on the console of your browser to switch verbose logging on and off:
[source,javascript]
----
window.oilVerboseModeOn();

window.oilVerboseModeOff();
----

Debug mode can be turned on at any time, whereas the similar "preview_mode" can only be enabled in the configuration, please see above.

Start debugging with figuring out which config was actually parsed, by looking at the "Got the following parsed config" message.

Please note that verbose logging can only be activated for your browser, all other users wont see those logs.

==== OIL Events

#2. Register an event handler with a callback to be executed when OIL fires the opt-in event or the user has opted in on an earlier occasion and revisits the page.
[source,javascript]
----
  <script type="text/javascript">
    // Cross browser event handler definition
    var eventMethod = window.addEventListener ? 'addEventListener' : 'attachEvent';
    var messageEvent = eventMethod === 'attachEvent' ? 'onmessage' : 'message';
    var eventer = window[eventMethod];

    // Callback to be executed when event is fired
    function receiveMessage(event) {
      function eventDataContains(str) {
        return JSON.stringify(event.data).indexOf(str) !== -1;
      }
      if (event && event.data && (eventDataContains('oil_optin_done') || eventDataContains('oil_has_optedin'))) {
        // Do something when event is fired...
        console.log("Do something when event is fired...");
      }
    }

    // Register event handler
    eventer(messageEvent, receiveMessage, false);
  </script>
----

OIL is currently emitting the following events:

[width="100%",options="header", cols="1,3"]
|====
| Event name | Description
| oil_optin_done | When a users selects opt in.
| oil_soi_optin_done | When a users selects opt in via SOI.
| oil_as_selected_minimum| When a users selected minimum cookies before clicking opt in.
| oil_as_selected_functional| When a users selected functional cookies before clicking opt in.
| oil_as_selected_full| When a user selected full cookies before clicking opt in or didn't bother for advanced settings.
| oil_click_advanced_settings| When a users clicks the advanced settings button/link.
| oil_click_back_to_main| When a user clicks the back link from the advanced settings page.
| oil_no_cookies_allowed| When a users has no cookies allowed and the no cookies layer is displayed
| oil_has_optedin| On every page reload, when the user has opted_in previously (OIL should be hidden)
| oil_shown| When oil is shown
|====

OIL is currently listening to the following events:
[width="100%",options="header", cols="1,3"]
|====
| Event name | Description
|oil_optout_trigger | Contrary this event is listened to by OIL and will remove all cookies if triggered and therefor opt_out.
|====

==== OIL CPC API

You can add an integrated version of the OIL Cookie Preference Center to your page to give the user the chance to reverse his initial selection.

For this include a div with the id below in your page:
[source,html]
----
<div id="oil-preference-center"></div>
----
To insert the OIL CPC in the prepared div, which you included in your page: window.oilShowPreferenceCenter(); Create a SAVE Button with one of the two possible actions: window.oilTriggerPoiOptin(); or window.oilTriggerSoiOptIn();

The inserted CPC will show the users current setting when inserted. Make sure OIL is part of the page to make this work.

These are all CPC API definitions:

[width="100%",options="header", cols="1,3"]
|====
| Function Name | Description
| window.oilShowPreferenceCenter() | inserts the CPC into the predefined div with the id #oil-preference-center into the host site
| window.oilTriggerSoiOptIn() | will trigger the CPC SOI optin (can also result in an optout)
| window.oilTriggerPoiOptin() | will trigger the CPC POI optin (can also result in an optout)
|====

==== Tracking and Google Analytics Events
The previous Google Analytics integration was removed from OIL to decrease the OIL file size. If you want to use Google Analytics with OIL you can use the new OIL Events (see above) instead and proxy them to your specific GA installation.
This makes OIL load quicker and gives more freedom how the tracking takes place.

This is an example script to subscribe to the event 'oil_optin_done' and forward it to Google Analytics. You might need to tweak it to your environment and needs.
[source,javascript]
----
// Multibrowser Support
var eventMethod = window.addEventListener ? 'addEventListener' : 'attachEvent';
var messageEvent = eventMethod === 'attachEvent' ? 'onmessage' : 'message';
var eventer = window[eventMethod];

function receiveOptInMessage(event) {
  function eventDataContains(str) {
    return JSON.stringify(event.data).indexOf(str) !== -1;
  }
  if (window.ga && window.ga.loaded && event && event.data && eventDataContains('oil_optin_done')) { // event name
    var nonInteraction = true; // should be set to false for non-click events
    window.ga('send', 'event', 'OIL', 'oil_optin_done', {'nonInteraction': nonInteraction});
  }
}

eventer(messageEvent, receiveMessage, false);
----

include::usage/kameleoon-integration.adoc[]



