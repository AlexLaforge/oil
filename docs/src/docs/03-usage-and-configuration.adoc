== Usage

=== How to implement OIL on your site

Setting up OIL on your page consists of the following steps:

** Add the oil.js javascript snippet to your page
** Add a configuration block to your pages DOM

OIL creates a standard for the Opt-In but can't automatically stop your site from tracking your users. So to actually make your page respond to opt-ins you also need to do the following.

** Make sure your page doesn't track the user in its default state.
** Use Tealium for all tracking activities and use the loading rules we provide
** Listen to OIL events for loading non-Tealium tags, after the user opted in.

==== Adding oil.js to your site via Tealium (recommended)

Axel Springer Tealium needs to configure your site to inherit the predefined lib-dip-optin library profile. Once this is in place you publish those changes in the following way:

* Open your Tealium profile and go to "extensions"
* Find the entry for "AS Opt-in Overlay", you'll be noticed of a change to this extension
* Publish / deploy your profile to activate the changes to Oil.js

[caption="Oil.js Tealium Deployment"]
image::src/images/tealium-user-profile-extension-view.png[Tealium Client Profile]

This needs to be repeated for every new version of OIL. The library profile can't push new code to your website without your action.

==== Adding oil.js to your site via direct integration

If Tealium can't be used on your site you also can add OIL directly from our CDN.

Example (replace with the latest version):
[source, html, subs="attributes"]
----
&lt;script type="text/javascript" src="https://oil.axelspringer.com/release/{version_raw}/oil.{version}.min.js">&lt;/script>
----

Updated versions of the script will be deployed using a different filename hence we'll never alter an existing version.

Please make sure you're working with the *latest version* available.

Please check https://oil.axelspringer.com/release for further updates. Choose the latest version or the version fitting to this documentation. Normalley there will be multiple files:

* oil.1.0.34-RELEASE.min.js - *This is the file you will need to reference in your website*
* hub.1.0.34-RELEASE.min.js
* Chunks, beginning with numbers - they will ne loaded asynchronously and you don't need to do anything with them.
** 0.1.0.34-RELEASE.chunk.js
** X.1.0.34-RELEASE.chunk.js


IMPORTANT: Your domain needs to be whitelisted in order to work with OIL (contact us to get whitelisted: OIL Support <oil-support@axelspringer.com>)

include::usage/configuration-of-oil.adoc[]

=== Listening and interacting with OIL

In addition to the configuration the host site can communicate with the OIL layer using its API. OIL, in its default state, never emits console errors.
To get a full log and all errors you can enable the verbose mode. For test deployments and A/B testing OIL supports a preview mode.

==== Test Deployment and Preview Mode
The preview mode is useful for testing OIL in a live environment without making it available to your end-users.

The preview mode is turned off by default, meaning OIL will be available to all your users. If you turn the preview mode on (please see configuration section), OIL won't be shown at first, but can be enabled for your current session on the browser's console:
[source,javascript]
----
window.AS_OIL.previewModeOn();
window.AS_OIL.previewModeOff();
----

When preview mode is turned on some debug information will be seen on the browser console. See also "Verbose Logging" below for more detailed logging.

==== OIL Verbose Logging
OIL will show no logs, except in preview mode or verbose mode.

Run the following commands on the console of your browser to switch verbose logging on and off:
[source,javascript]
----
window.AS_OIL.verboseModeOn();
window.AS_OIL.verboseModeOff();
----

Debug mode can be turned on at any time, whereas the similar preview mode can only be enabled in the configuration, please see above.

Please note that verbose logging can only be activated for your own browser, all other users won't see those logs.

==== OIL API

[width="100%",options="header", cols="1,3"]
|====
| API Call | Description
|window.AS_OIL.triggerOptIn(); | The user will opted in. It's the same behaviour as when the user is clicking Accept on the layer.
|window.AS_OIL.triggerOptOut(); | OIL will remove all cookies if triggered and therefore opt-out the user of everything, even POI.
|window.AS_OIL.reload(); | OIL will reload the configuration from the host's website.
|window.AS_OIL.showPreferenceCenter(); | OIL will inject the Cookie Preference Center into your website. Please see "OIL CPC API" section.
|====

==== OIL Events

#2. Register an event handler with a callback to be executed when OIL fires the opt-in event or the user has opted in on an earlier occasion and revisits the page.
[source,javascript]
----
  <script type="text/javascript">
    // Cross browser event handler definition
    var eventMethod = window.addEventListener ? 'addEventListener' : 'attachEvent';
    var messageEvent = eventMethod === 'attachEvent' ? 'onmessage' : 'message';
    var eventer = window[eventMethod];

    // Callback to be executed when event is fired
    function receiveMessage(event) {
      function eventDataContains(str) {
        return JSON.stringify(event.data).indexOf(str) !== -1;
      }
      if (event && event.data && (eventDataContains('oil_optin_done') || eventDataContains('oil_has_optedin'))) {
        // Do something when event is fired...
        console.log("Do something when event is fired...");
      }
    }

    // Register event handler
    eventer(messageEvent, receiveMessage, false);
  </script>
----

OIL is currently emitting the following events:

[width="100%",options="header", cols="1,3"]
|====
| Event name | Description
| oil_optin_done | When a users selects opt-in.
| oil_as_selected_minimum| When a users selected minimum cookies before clicking opt-in.
| oil_as_selected_functional| When a users selected functional cookies before clicking opt-in.
| oil_as_selected_full| When a user selected full cookies before clicking opt-in or didn't bother for advanced settings.
| oil_click_advanced_settings| When a users clicks the advanced settings button/link.
| oil_click_back_to_main| When a user clicks the back link from the advanced settings page.
| oil_no_cookies_allowed| When a users has no cookies allowed and the no cookies layer is displayed
| oil_has_optedin| On every page reload, when the user has opted_in previously (OIL should be hidden)
| oil_shown| When oil is shown
| oil_hide_layer| When oil gets automatically hidden
| oil_click_thirdparty_list| When a user clicks the third party list link
| oil_click_company_list| When a user clicks the company list link
|====

==== OIL CPC API

You can add an integrated version of the OIL Cookie Preference Center to your page to give the user the chance to reverse his initial selection (or even Opt-Out).

For this include a div with the id below in your page:
[source,html]
----
<div id="oil-preference-center"></div>
----
To insert the OIL CPC in the prepared div, which you included in your page, execute this javascript snippet:
[source,javascript]
----
window.AS_OIL.showPreferenceCenter();
----

For the action element to save the current setting there is an API endpoint:

[source,javascript]
----
window.oilTriggerOptin();
----

The inserted CPC will show the users current setting when inserted. Make sure OIL is part of the page first to make this work.

CPC API definition:

[width="100%",options="header", cols="1,3"]
|====
| Function Name | Description
| window.AS_OIL.showPreferenceCenter() | inserts the CPC into the predefined div with the id #oil-preference-center into the host site
| window.AS_OIL.triggerOptIn() | will trigger the generic opt-in (can also result in an opt-out)
|====

==== Tracking and Google Analytics Events
If you want to use Google Analytics with OIL you can use OIL Events (see above) and proxy them to your specific GA installation.

This is an example script to subscribe to the event 'oil_optin_done' and forward it to Google Analytics. You might need to tweak it to your environment and needs.
[source,javascript]
----
// Multibrowser Support
var eventMethod = window.addEventListener ? 'addEventListener' : 'attachEvent';
var messageEvent = eventMethod === 'attachEvent' ? 'onmessage' : 'message';
var eventer = window[eventMethod];

function receiveOptInMessage(event) {
  function eventDataContains(str) {
    return JSON.stringify(event.data).indexOf(str) !== -1;
  }
  if (window.ga && window.ga.loaded && event && event.data && eventDataContains('oil_optin_done')) { // event name
    var nonInteraction = true; // should be set to false for non-click events
    window.ga('send', 'event', 'OIL', 'oil_optin_done', {'nonInteraction': nonInteraction});
  }
}

eventer(messageEvent, receiveMessage, false);
----

include::usage/kameleoon-integration.adoc[]



