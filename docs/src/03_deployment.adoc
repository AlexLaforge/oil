:project_root: ../../

== Deployment View

[[section-deployment-view]]

[NOTE]
====
For the purpose of the PoC the deployment to Tealium is done mainly manual for following stages:
- prod
- debug / development

Only the end2end stage has an "automatic" update via a CDN.
====

[caption="Deployment"]
image::src/images/deployment.png[OIL Deployment]

=== Hub Deployment
To deploy the hub (i.e. as a MyPass service) you need to deploy the project with an index.html loading dist/hub.123.js. In our examples this is demos/complete-integration-mypass.html

For compatibility with Internet Explorer 9+ you need to add the following header to the server response to allow 3rd party cookies for POI. It's needed in SOI only mode.

[source,json]
----
include::{project_root}/etc/headerConfig.js[tags=p3p-config]
----

=== Tealium Deployment
For our PoC we decided to use Tealium to deliver our Javascript artefact to client browsers. To achieve this you have to follow some steps:

As a developer of Oil.js (see image below)

* Open your Tealium lib profile and move to extensions
* Open the predefined Javascript extension "AS Opt-in Overlay"
* Some forms will show up, paste your code (dist/subscriber.123.js) in the "configuration" section
* Save and Publish your Tealium configuration changes in your desired stages (Dev, QA, Prod)

Please note that once published, your code will be delivered to all Tealium clients automatically.
Tealium clients will be informed of your changes and need to publish/deploy their profile to activate your changes.

[caption="Oil.js Tealium Deployment"]
image::src/images/tealium-lib-profile-extension-view.png[Tealium Library Profile]

As a client of Tealium (see image below)

* Open your Tealium profile and move to "extensions"
* Find the entry for "AS Opt-in Overlay", you'll be noticed of a change to this extension
* Publish / deploy your profile to activate the changes to Oil.js

[caption="Oil.js Tealium Deployment"]
image::src/images/tealium-user-profile-extension-view.png[Tealium Client Profile]

Within an extension it's possible to handle the OptOut/OptIn logic during preload. This also allows to alter the later behaviour within Tealium.

.OIL Configuration
****
You need to add an OIL configuration to the html of your host and hub site. This is an example configuration:

[source,json]
----
    <script type="application/configuration">
      {
        "activate_poi": true,
        "hub_origin": "//www.somedomain.com",
        "hub_path": "/some/path.html",
        "subscriber_set_cookie": true,
        "opt_in_event_name": "oil_optin_done_custom",
        "opt_later_event_name": "oil_optlater_custom",
        "opt_out_event_name": "oil_optout_trigger",
        "developer_mode": "true",
        "privacy_page_location": "http://www.welt.de/datenschutz"
      }
    </script>
----

.Configuration Parameter
[width="100%",options="header", cols="1,3,1"]
|===
| Config Parameter | Description | Default Setting
| activate_poi | Activates or disactivates __Power Opt In__. Rememeber that you also have to setup the hub.js part if you do so, or you will endup with a non-working button. | false
| hub_origin | The origin of the hub.js installation, if any. | none
| hub_path | The path to the hub.html installation on the origin, if any. | none
| subscriber_set_cookie | Whether to set the __SOI__ cookie on __POI__ opt-ins or not. | true
| opt_in_event_name | The event name that will be sent to the window of the host site on opt-in. This will be fired on returning visits as well, when the user already opted in. | 'oil_optin_done'
| opt_later_event_name | The event name that will be sent to the window of the host site on opt-later. This will be fired on returning visits as well, when the user delayed the optin for later. | 'oil_optlater_trigger'
| opt_out_event_name | The event name __OIL__ is listening to for opting out. The opt-out functionality can be implemented in the settings part of the host site. | 'oil_optout_trigger'
| developer_mode | If developer mode is activated, the overlay won't show unless a specific cookie is set. Set a cookie with the name "oil_developer" and the value "true" to activate the layer for your client. | true
| privacy_page_location | __OIL__ should contain text, that refers to an external page detailing privacy ("Datenschutz"). If you add the key "privacy_page_location" and give it a value other than an empty string, a "Mehr erfahren" ('show more') text link will be added to __OIL__. It opens a page with the value you specified in a new tab or window. | "" (empty string)
|===

****
