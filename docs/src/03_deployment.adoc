:project_root: ../../

[[section-deployment-view]]


== Deployment View

[NOTE]
====
For the purpose of the PoC the deployment to Tealium is done mainly manual for following stages:
- prod
- debug / development

Only the end2end stage has an "automatic" update via a CDN.
====

[caption="Deployment"]
image::src/images/deployment.png[OIL Deployment]

=== Hub Deployment
To deploy the hub (i.e. as a MyPass service) you need to deploy the project with an index.html loading dist/hub.123.js. In our examples this is demos/complete-integration-mypass.html

For compatibility with Internet Explorer 9+ you need to add the following header to the server response to allow 3rd party cookies for POI. It's needed in SOI only mode.

[source,json]
----
include::{project_root}/etc/headerConfig.js[tags=p3p-config]
----

=== Tealium Deployment
For our PoC we decided to use Tealium to deliver our Javascript artefact to client browsers. To achieve this you have to follow some steps:

As a developer of Oil.js (see image below)

* Open your Tealium lib profile and move to extensions
* Open the predefined Javascript extension "AS Opt-in Overlay"
* Some forms will show up, paste your code (dist/subscriber.123.js) in the "configuration" section
* Save and Publish your Tealium configuration changes in your desired stages (Dev, QA, Prod)

Please note that once published, your code will be delivered to all Tealium clients automatically.
Tealium clients will be informed of your changes and need to publish/deploy their profile to activate your changes.

[caption="Oil.js Tealium Deployment"]
image::src/images/tealium-lib-profile-extension-view.png[Tealium Library Profile]

As a client of Tealium (see image below)

* Open your Tealium profile and move to "extensions"
* Find the entry for "AS Opt-in Overlay", you'll be noticed of a change to this extension
* Publish / deploy your profile to activate the changes to Oil.js

[caption="Oil.js Tealium Deployment"]
image::src/images/tealium-user-profile-extension-view.png[Tealium Client Profile]

Within an extension it's possible to handle the OptOut/OptIn logic during preload. This also allows to alter the later behaviour within Tealium.

.OIL Configuration
****
You need to add an OIL configuration to the html of your host and hub site. This is an example configuration:

[source,json]
----
    <script type="application/configuration">
      {
        "activate_poi": true,
        "hub_origin": "//www.somedomain.com",
        "hub_path": "/some/path.html",
        "subscriber_set_cookie": true,
        "opt_in_event_name": "oil_optin_done_custom",
        "opt_later_event_name": "oil_optlater_custom",
        "opt_out_event_name": "oil_optout_trigger",
        "developer_mode": "true"
      }
    </script>
----

activate_poi: The Power-Opt-In feature will only be activated if this switch is true. Rememeber that you also have to setup the hub.js part if you do so, or you will endup with a non-working button. Default: false

hub_origin: The origin of the hub.js installation, if any. Default: none.

hub_path: The path to the hub.html installation on the origin, if any. Default: none.

subscriber_set_cookie: Whether to set the SOI cookie on POI opt-ins or not. Default: true

opt_in_event_name: The event name that will be sent to this window on opt-in. This will be fired on returning visits as well, when the user already opted in. Default: 'oil_optin_done'

opt_later_event_name: The event name that will be sent to this window on opt-later. This will be fired on returning visits as well, when the user delayed the optin for later. Default: 'oil_optlater_trigger'

opt_out_event_name: The event name on this window the OIL-Library is listening to for opting out. The opt-out functionality can be implemented in the settings part of the host site. Default: 'oil_optout_trigger'

developer_mode: If developer mode is activated, the overlay won't show unless a specific cookie is set. Set a cookie with the name "oil_developer" and the value "true" to activate the layer for your client. Default: true
****
